#!/bin/bash

set -e

db=${1}
src=${2:-"postgres://postgres@devvm-postgres:5432"}
dst=${3:-"postgres://postgres@localhost:5433"}
file="${db}_$(date +%Y-%m-%d).backup"

echo "Dumping ${src}/${db} to ${file}"
pg_dump --dbname="${src}/${db}" --format="custom" --blobs --file="${file}"

echo "Killing connections to ${dst}/${db}"
psql ${dst} --command="SELECT pg_terminate_backend(pg_stat_activity.pid)
                        FROM pg_stat_activity
                        WHERE pg_stat_activity.datname = '${db}'
                        AND pid <> pg_backend_pid();" 1>/dev/null

echo "Restoring ${file} to ${dst}/${db}"
pg_restore --dbname="${dst}" --format="custom" --create --clean "${file}"
